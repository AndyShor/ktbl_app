<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">
    <title>KTBL app</title>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-2.2.3.min.js"></script>
<script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.2.3.min.js"></script>
<script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.2.3.min.js"></script>
<script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-api-2.2.3.min.js"></script>
<script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-api-2.2.3.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="https://kit.fontawesome.com/f0601b0fb2.js" crossorigin="anonymous"></script>
    <script type='module' src='https://unpkg.com/ionicons@5.0.0/dist/ionicons/ionicons.esm.js'></script>
    <script nomodule='' src='https://unpkg.com/ionicons@5.0.0/dist/ionicons/ionicons.js'></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link rel="stylesheet" href="assets/css/style.css">

   


</head>

<body translate="no" >

          <div class="btn__main">
          
            <div class="btn" id="startBtn" onclick="connectToDevice()"><img src="assets/img/start.png"></div>
  
            </div>
          
          
          
          <div class="btn__main">
          
          <div class="btn" id="stopBtn" onclick="disconnect()"><img src="assets/img/stop.png"></div>
          </div> 
          <div id="plot"></div>

 
  

<script> 
  // define global variables 

  
  var device;
   var gx_values=[];
   var gy_values=[];
   var gz_values=[];
   var t_values=[];
   var t_0=0;

    async function connectToDevice() {
     // zero global data arrays from previous runs
     t_0=Date.now()/1000;
     gx_values=[];
     gy_values=[];
     gz_values=[];
     t_values=[];

  
      // Request Bluetooth permission
  if (!navigator.bluetooth) {
    throw new Error('Web Bluetooth API is not supported');
  }

  try {
    // Create a filter to search for devices with the specified name
    const name = 'ktbl'
    let options = {
    filters: [
     
     { name: "ktbl" },
          ],
     
    };


    const filter = { name: name };

    // Start scanning for devices
    //const device = await navigator.bluetooth.requestDevice(options);
    device = await navigator.bluetooth.requestDevice({
    filters: [
      {name: 'ktbl',
      
      }
    ],
    optionalServices: ['19b10010-e8f2-537e-4f6c-d104768a1214', '00001800-0000-1000-8000-00805f9b34fb']
  });

    // Connect to the device
    const server = await device.gatt.connect();

    // Get the primary service
    const service = await server.getPrimaryService('generic_access');

    // Get the characteristic
    const characteristic = await service.getCharacteristic('00002a00-0000-1000-8000-00805f9b34fb');

    // Read the characteristic value to verify the device name
    const value = await characteristic.readValue();
    const deviceName = new TextDecoder('utf-8').decode(value);
    console.log(`Connected to device: ${deviceName}`);

    if (deviceName !== name) {
      //throw new Error('Device name mismatch');
      console.log(`Connected to device with different name  ${deviceName}`);
    }

    console.log(`Connected to device: ${name}`);
  
  const serviceUuid = '19b10010-e8f2-537e-4f6c-d104768a1214';
  const characteristicUuid = '19b10011-e8f2-537e-4f6c-d104768a1214';
  const mvmnt_service = await server.getPrimaryService(serviceUuid);
  const mvmnt_characteristic = await mvmnt_service.getCharacteristic(characteristicUuid);
  await mvmnt_characteristic.startNotifications();
  console.log(`started notifications`);
  mvmnt_characteristic.addEventListener('characteristicvaluechanged', handleNotifications);

    return server;
  } catch (error) {
    console.error('Error connecting to device:', error);
    return null;
  }
 



}

function handleNotifications(event) {
  let payload = event.target.value;
  let payload_size=payload.byteLength;
  let t_now=Date.now()/1000;
  if (payload_size !== 24) {
    console.log(`wrong payload size of : ${ payload_size} bytes`);
  }
  
  
  //console.log(`received: ${payload.byteLength}`);
  const view = new DataView(payload.buffer);
  //const int16Values = [];
  gx_values.push(view.getInt16(0, true));
  gy_values.push(view.getInt16(2, true));
  gz_values.push(view.getInt16(4, true));
  t_values.push(t_now-t_0);
  
  //for (let i = 0; i <payload_size/2 ; i++){
   // int16Values.push(view.getInt16(i*2, true));
    
    //const byte = payload.getUint8(i);
    //console.log(`Byte ${i}: 0x${byte.toString(16).padStart(2, '0')}`);

    //int8Values.push(view.getUint8(i));
  //}

  //console.log(`received: ${int16Values}`);
}

function plotGraph(xData, yData) {
        if (typeof Bokeh !== 'undefined' && Bokeh.Plotting && Bokeh.Plotting.figure) {
          const plot = Bokeh.Plotting.figure({
            title: 'Plot of x vs y',
            x_axis_label: 'x',
            y_axis_label: 'y',
            plot_width: 600,
            plot_height: 400
          });

          const line = Bokeh.Plotting.line({
            x: xData,
            y: yData,
            line_width: 2,
            line_color: 'blue'
          });

          plot.add_glyph(line);
          Bokeh.Plotting.show(plot);
        } else {
          console.error("Bokeh is not loaded yet.");
        }
      }



    

function disconnect(){
  console.log(`received: ${gx_values}`);
  console.log(`received: ${gy_values}`);
  console.log(`received: ${gz_values}`);
  console.log(`received: ${t_values}`);
  device.gatt.disconnect();
  plotGraph(t_values, gx_values);


}


</script>

</body>

</html>

